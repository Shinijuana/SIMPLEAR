<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
</head>
<body>
  <!-- Overlay di scansione per il tracciamento dell'image target -->

  <!-- Configurazione di A-Frame con MindAR -->
  <a-scene mindar-image="uiScanning: no; imageTargetSrc: https://raw.githack.com/Shinijuana/MARKERTHREE/main/dos.mind; filterMinCF:0.01; filterBeta: 100; warmupTolerance: 1; missTolerance: 1;" 
           tensorflow-contour-processor
           typewriting
           next-button
           xrweb="disableWorldTracking: false; allowedDevices: any"
           color-space="sRGB" 
           renderer="colorManagement: true, physicallyCorrectLights" 
           vr-mode-ui="enabled: false" 
           embedded
           device-orientation-permission-ui="enabled: false">
    
    <!-- Caricamento degli asset -->
    <a-assets>
      <a-asset-item id="busto" src="https://raw.githack.com/Shinijuana/MARKERTHREE/main/assets/busto%20emilio.gltf"></a-asset-item>
      <a-asset-item id="web" src="assets/web.glb"></a-asset-item>
      <a-asset-item id="phone" src="assets/phone.glb"></a-asset-item>
      <a-asset-item id="mail" src="assets/mail.glb"></a-asset-item>
      <a-asset-item id="vcf" src="assets/vcf.glb"></a-asset-item>
      <img id="balloonTexture" src="assets/balloon.png" />
    </a-assets>

    <!-- Configurazione della telecamera -->
    <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;" raycaster="near: 10; far: 10000; objects: .clickable">
    <a-image
      id="startImage"
      src="assets/markerdos.jpg"
      position="0 0 -15"
      scale="10 7 10"
      opacity=".8"
      visible="true"
      animation__pulse="property: scale; from: 5 5 5; to: 5.5 5.5 5.5; dir: alternate; loop: true; dur: 1000">
    </a-image>
    <a-image
      id="finalp"
      src="assets/final.png"
      position="0 .2 -5"
      scale="3.5 7 1"
      opacity="1"
      visible="false">
    </a-image>
    <a-image
      id="reload"
      src="assets/reload.png"
      position="0 1.8 -4"
      scale=".6 .6 .6"
      opacity="1"
      class="clickable"
      visible="false">
    </a-image>
    <a-image
      id="down"
      src="assets/vcf3.png"
      position="0 -1.5 -4"
      scale=".4 .4 .4"
      opacity="1"
      class="clickable"
      visible="false">
    </a-image>
    <a-image
      id="closeButton"
      src="assets/close.png"
      position="1.05 1 -4"
      scale=".3 .3 .3"
      opacity="1"
      class="clickable"
      visible="true">
    </a-image>
    </a-camera>
    
    <a-light type="directional" intensity="0.5" position="1 1 1"></a-light>
    <a-light type="ambient" intensity="0.7"></a-light>
 

    <!-- Entità per il target AR e il modello 3D -->
    <a-entity id="example-target" mindar-image-target="targetIndex: 0;" position="0 0 0" rotation="0 0 0" scale="1 1 1" keepvisibleonlost >
      <a-entity
        id="model"
        rotation="90 0 0" 
        position="0 0 0" 
        scale="2 2 2" 
        gltf-model="#busto"
        class="clickable"
        animation__move="property: position; from: 0 0 0.5; to: 0 0 .9; dur: 1680; loop: true; dir: alternate; easing: easeInOutSine;">
      </a-entity>
      <a-entity
      gltf-model="#web"
      id="nextbutton"
      position="-.8 0 .5"
      rotation="90 0 0"
      scale="1 1 1"
      class="clickable"
      visible="false">
    </a-entity>
    <a-entity
      gltf-model="#phone"
      id="phoneButton"
      position="0 0 2.5"
      rotation="90 0 0"
      scale="1 1 1"
      class="clickable"
      visible="false">
    </a-entity>
    <a-entity
      gltf-model="#mail"
      id="emailButton"
      position=".8 0 .5"
      rotation="90 0 0"
      scale="1 1 1"
      class="clickable"
      visible="false">
    </a-entity>
    <a-entity
      gltf-model="#vcf"
      id="vcfButton"
      position="0 0 -.1.5"
      rotation="90 0 0"
      scale="1 1 1"
      class="clickable"
      visible="false">
    </a-entity>
    <a-plane
      id="balloon-plane"
      scale=".35 .35 .35"
      rotation="90 0 0"
      width="3"
      height="1"
      visible="true"
      src="#balloonTexture"
      material="transparent: true; opacity: 1; side: double;"
      animation__move="property: position; from: -.6 -.3 1.1; to: -.6 -.3 1.6; dur: 1680; loop: true; dir: alternate; easing: easeInOutSine;">
      <a-text
        id="balloon-text"
        rotation="0 0 0"
        position="0 .15 .05"
        typewriting="value: ."
        align="center"
        width="2.7"
        color="#0000ff">
      </a-text>
    </a-plane>
    </a-entity>
</a-scene>

 <!-- KEEPVISIBLE -->
  <script>
 AFRAME.registerComponent('keepvisibleonlost', {
  init: function () {
    var el = this.el;

    // Ascolta l'evento targetLost
    el.sceneEl.addEventListener("targetLost", function () {
      // Accedi all'oggetto 3D tramite Three.js e imposta la visibilità
      el.object3D.visible = true;
    });

    // Ascolta l'evento targetFound (opzionale se vuoi fare qualcosa quando viene trovato)
    el.sceneEl.addEventListener("targetFound", function () {
      console.log("Target trovato");

      // Opzionale: Nascondi un altro oggetto (ad esempio, un'immagine di avvio)
      const startImage = document.getElementById('startImage');
      if (startImage) {
        startImage.object3D.visible = false; // Usa object3D per nascondere l'oggetto
      }
    });
  }
});

</script>

  <!-- BOTTONI -->
<script>
AFRAME.registerComponent('next-button', {
  init() {
    // Dichiarazione delle costanti
    const char = document.getElementById('model');
    const nextButton = document.getElementById('nextbutton');
    const phoneButton = document.getElementById('phoneButton');
    const mailButton = document.getElementById('emailButton');
    const vcfButton = document.getElementById('vcfButton');
    const textElement = document.querySelector('#balloon-text');
    const balloon = document.getElementById('balloon-plane');
    const closeButton = document.getElementById('closeButton');
    const finalpage = document.getElementById('finalp');
    const refr = document.getElementById('reload');
    const download = document.getElementById('down');

    // Scritta iniziale con delay
    setTimeout(() => {
      textElement.setAttribute('typewriting', 'value: Hello, I\'m Emilio Lonardo, Ceo & Co-Founder of D.O.S.. Tap for more!');
    }, 6000);

    // Funzioni bottoni
    if (nextButton) {
      nextButton.onclick = () => {
        window.open('https://designopenspaces.it/', '_blank');
      };
    }

    if (phoneButton) {
      phoneButton.onclick = () => {
        window.open('tel:+393274942494', '_self');
      };
    }

    if (mailButton) {
      mailButton.onclick = () => {
        window.open('mailto:emilio.lonardo@designopenspaces.it', '_self');
      };
    }

    if (vcfButton) {
      vcfButton.onclick = () => {
        const downloadUrl = 'https://drive.google.com/uc?export=download&id=1DqanjcQqU1FXM29gRwWMe5noW_TxAj2U';
        window.open(downloadUrl, '_self');

        if (textElement) {
          textElement.setAttribute('typewriting', 'value: Downloading contact info!');
        }
        if (balloon) {
          balloon.setAttribute('visible', 'true');
          balloon.setAttribute('animation__pulse', 'property: scale; from: 0 0 0; to: 0.35 0.35 0.35; dir: alternate; dur: 1000');
          setTimeout(() => {
            balloon.setAttribute('animation__pulse', 'property: scale; from: 0.35 0.35 0.35; to: 0 0 0; dir: alternate; dur: 1000');
            setTimeout(() => {
              balloon.setAttribute('visible', 'false');
            }, 1000);
          }, 3000);
        }
      };
    }

    if (closeButton) {
      closeButton.onclick = () => {
        const isBalloonVisible = balloon.getAttribute('visible') === 'true';
        // Quando il balloon è visibile
        if (isBalloonVisible) {
          textElement.setAttribute('typewriting', 'value: Bye Bye!');
          if (refr) {
            refr.onclick = () => {
              window.location.reload();
            };
          }

          if (download) {
            download.onclick = () => {
              const downloadUrl = 'https://drive.google.com/uc?export=download&id=1DqanjcQqU1FXM29gRwWMe5noW_TxAj2U';
              window.open(downloadUrl, '_self');
            };
          }

          // Animazioni alla chiusura
          setTimeout(() => {
            char.setAttribute('animation__pulse', 'property: scale; from: 1.5 1.5 1.5; to: 0 0 0; dir: alternate; dur: 1000');
            char.setAttribute('animation__rotation', 'property: rotation; from: 90 0 0; to: 720 0 0; dir: alternate; dur: 1000');
            balloon.setAttribute('animation__pulse', 'property: scale; from: .35 .35 .35; to: 0 0 0; dir: alternate; dur: 1000');
            nextButton.setAttribute('visible', 'false');
            phoneButton.setAttribute('visible', 'false');
            mailButton.setAttribute('visible', 'false');
            vcfButton.setAttribute('visible', 'false');
          }, 1000);

          setTimeout(() => {
            char.setAttribute('visible', 'false');
            closeButton.setAttribute('visible', 'false');
            finalpage.setAttribute('visible', 'true');
            finalpage.setAttribute('animation__pulse', 'property: scale; from: 0 0 0; to: 3.5 7 1; dir: alternate; dur: 100');
            refr.setAttribute('visible', 'true');
            download.setAttribute('visible', 'true');
            balloon.setAttribute('visible', 'false'); // Assicurati che il balloon venga nascosto dopo la chiusura
          }, 2000);
        } else {
          // Balloon non visibile
          balloon.setAttribute('visible', 'true');
          balloon.setAttribute('animation__pulse', 'property: scale; from: 0 0 0; to: 0.35 0.35 0.35; dir: alternate; dur: 1000');
          textElement.setAttribute('typewriting', 'value: Bye Bye!');
          if (refr) {
            refr.onclick = () => {
              window.location.reload();
            };
          }

          if (download) {
            download.onclick = () => {
              const downloadUrl = 'https://drive.google.com/uc?export=download&id=1DqanjcQqU1FXM29gRwWMe5noW_TxAj2U';
              window.open(downloadUrl, '_self');
            };
          }

          // Animazioni alla chiusura
          setTimeout(() => {
            char.setAttribute('animation__pulse', 'property: scale; from: 1.5 1.5 1.5; to: 0 0 0; dir: alternate; dur: 1000');
            char.setAttribute('animation__rotation', 'property: rotation; from: 90 0 0; to: 720 0 0; dir: alternate; dur: 1000');
            nextButton.setAttribute('animation__pulse', 'property: scale; from: 1 1 1; to: 0 0 0; dir: alternate; dur: 1000');
            nextButton.setAttribute('animation__move', 'property: position; from:-.8 0 .5 ; to: 0 0 0; dur: 1000; easing: linear');
            phoneButton.setAttribute('animation__pulse', 'property: scale; from: 1 1 1; to: 0 0 0; dir: alternate; dur: 1000');
            phoneButton.setAttribute('animation__move', 'property: position; from: 0 0 1.65 ; to: 0 0 0; dur: 1000; easing: linear');
            mailButton.setAttribute('animation__pulse', 'property: scale; from: 1 1 1; to: 0 0 0; dir: alternate; dur: 1000');
            mailButton.setAttribute('animation__move', 'property: position; from:.8 0 .5 ; to: 0 0 0; dur: 1000; easing: linear');
            vcfButton.setAttribute('animation__pulse', 'property: scale; from: 1 1 1; to: 0 0 0; dir: alternate; dur: 1000');
            vcfButton.setAttribute('animation__move', 'property: position; from:0 0 -.5 ; to: 0 0 0; dur: 1000; easing: linear');
          }, 1000);

          setTimeout(() => {
            char.setAttribute('visible', 'false');
            closeButton.setAttribute('visible', 'false');
            finalpage.setAttribute('visible', 'true');
            finalpage.setAttribute('animation__pulse', 'property: scale; from: 0 0 0; to: 3.5 7 1; dir: alternate; dur: 100');
            refr.setAttribute('visible', 'true');
            download.setAttribute('visible', 'true');
            balloon.setAttribute('visible', 'false'); // Assicurati che il balloon venga nascosto dopo la chiusura
          }, 2000);
        }
      };
    }

    // Animazioni e opzione di frasi
    let isVisible = false;
    if (char) {
      char.onclick = () => {
        if (!isVisible) {
          if (textElement) {
            textElement.setAttribute('typewriting', 'value: Hello, I\'m Emilio Lonardo, Ceo & Co-Founder of D.O.S.. Tap for more!');
          }
          if (balloon) {
            balloon.setAttribute('animation__pulse', 'property: scale; from: 0.35 0.35 0.35; to: 0 0 0; dir: alternate; dur: 1000');
            setTimeout(() => {
              balloon.setAttribute('visible', 'false');
            }, 1000);
          }
          [nextButton, phoneButton, mailButton, vcfButton].forEach((button) => {
            if (button) {
              button.setAttribute('visible', 'true');
              button.setAttribute('animation__pulse', 'property: scale; from: 0 0 0; to: 1 1 1; dir: alternate; dur: 1000');
              button.setAttribute('animation__move', `property: position; from: 0 0 0; to: ${button.id === 'nextbutton' ? '-.8 0 .5' : button.id === 'phoneButton' ? '0 0 1.65' : button.id === 'emailButton' ? '.8 0 .5' : '0 0 -.5'}; dur: 1000; easing: linear`);
            }
          });
          isVisible = true;
        } else {
          if (textElement) {
            textElement.setAttribute('typewriting', 'value: Hello, I\'m Emilio Lonardo, Ceo & Co-Founder of D.O.S.. Tap for more!');
          }
          if (balloon) {
            balloon.setAttribute('visible', 'true');
            balloon.setAttribute('animation__pulse', 'property: scale; from: 0 0 0; to: 0.35 0.35 0.35; dir: alternate; dur: 1000');
          }
          [nextButton, phoneButton, mailButton, vcfButton].forEach((button) => {
            if (button) {
              button.setAttribute('animation__pulse', 'property: scale; from: 1 1 1; to: 0 0 0; dir: alternate; dur: 1000');
              button.setAttribute('animation__move', `property: position; from: ${button.id === 'nextbutton' ? '-.8 0 .5' : button.id === 'phoneButton' ? '0 0 1.65' : button.id === 'emailButton' ? '.8 0 .5' : '0 0 -.5'}; to: 0 0 0; dur: 1000; easing: linear`);
            }
          });

          setTimeout(() => {
            [nextButton, phoneButton, mailButton, vcfButton].forEach((button) => {
              if (button) button.setAttribute('visible', 'false');
            });
          }, 1000);
          isVisible = false;
        }
      };
    }
  },
});

</script>
  
    <!-- MACCHINA DA SCRIVERE -->
<script>
  AFRAME.registerComponent('typewriting', {
  schema: {
    value: {type: 'string'},
    speed: {type: 'number', default: 10},
  },
  init() {
    this.typewriterEffect = this.typewriterEffect.bind(this)
  },
  update(oldData) {
    if (oldData.value !== this.data.value) {
      this.typewriterEffect()
    }
  },
  typewriterEffect() {
    const element = this.el
    const text = this.data.value
    const {speed} = this.data

    let index = 0
    element.setAttribute('value', '')

    const type = () => {
      if (index < text.length) {
        element.setAttribute('value', element.getAttribute('value') + text.charAt(index))
        index++
        setTimeout(type, speed)
      }
    }

    type()
  },
})
</script>

  

   <!-- OPENCV -->
  <script>
    // Componente A-Frame
AFRAME.registerComponent('tensorflow-contour-processor', {
  schema: {
    targetName: {type: 'string'},
  },

  init() {
    // Carica OpenCV.js
    this.loadOpenCV()
  },

  loadOpenCV() {
    // Aggiungi messaggio di debug
    console.log('Loading OpenCV.js...')

    // Carica OpenCV.js se non è già stato caricato
    if (!window.cv) {
      const opencvScript = document.createElement('script')
      opencvScript.src = 'https://docs.opencv.org/master/opencv.js'
      opencvScript.async = true
      opencvScript.onload = () => {
        console.log('OpenCV.js script loaded.')
      }
      opencvScript.onerror = () => {
        console.error('Failed to load OpenCV.js script.')
      }
      document.head.appendChild(opencvScript)
    } else {
      // Se OpenCV.js è già stato caricato, chiama direttamente l'inizializzazione
      console.log('OpenCV.js is already loaded.')
      onOpenCvReady()
    }
  },

  initializeWebcamAndCanvas() {
    const video = document.createElement('video')
    video.setAttribute('autoplay', '')
    document.body.appendChild(video)

    const canvas = document.createElement('canvas')
    document.body.appendChild(canvas)
    const ctx = canvas.getContext('2d')

    // Messaggio di debug
    console.log('Initializing webcam...')

    navigator.mediaDevices.getUserMedia({video: true})
      .then((stream) => {
        video.srcObject = stream
        video.onloadedmetadata = () => {
          canvas.width = video.videoWidth
          canvas.height = video.videoHeight

          // Messaggio di debug
          console.log('Webcam initialized. Video dimensions:', video.videoWidth, video.videoHeight)

          // Loop per il rilevamento
          const processFrame = () => {
            ctx.drawImage(video, 0, 0)
            const src = cv.imread(canvas)
            const dst = new cv.Mat()
            cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY)
            cv.Canny(src, dst, 50, 100)
            cv.imshow(canvas, dst)

            // Messaggi di debug
            console.log('Frame processed.')
            console.log('Source matrix shape:', src.rows, src.cols)
            console.log('Destination matrix shape:', dst.rows, dst.cols)

            src.delete()
            dst.delete()
            requestAnimationFrame(processFrame)
          }
          requestAnimationFrame(processFrame)
        }
      })
      .catch((err) => {
        console.error('Error accessing webcam:', err)
      })
  },

  remove() {
    // Pulizia
    const video = document.querySelector('video')
    const canvas = document.querySelector('canvas')

    if (video) {
      if (!video.paused) {
        video.pause()
      }
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop())
      }
      document.body.removeChild(video)
    }

    if (canvas) {
      document.body.removeChild(canvas)
    }

    // Messaggio di debug
    console.log('Cleanup complete.')
  },
})
  </script>
</body>
</html>
